<!-- ============================================================== -->
<!-- Start right Content here -->
<!-- ============================================================== -->
<div class="main-content">

    <div class="page-content">
        <div class="container-fluid">

            <!-- start page title -->
            <div class="row">
                <div class="col-12">
                    <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                        <h4 class="">Coupons</h4>

                        <div class="page-title-right">
                            <ol class="breadcrumb m-0">
                                <li class="breadcrumb-item"><a href="javascript: void(0);">Admin</a></li>
                                <li class="breadcrumb-item active">Coupons</li>
                            </ol>
                        </div>

                    </div>
                </div>
            </div>
            <!-- end page title -->

            <section class="content-main">

                <div class="card" id="table_change">
                    <div class="card-body" id="">
                        <div class="row">
                            <div class="col-md-4">

                                <form id="form">

                                    <div class="mb-4 mb-3">
                                        <label class="cabinet center-block">
                                            <figure>
                                                <img style=" width: 272px; height: 295px;"
                                                    src="/user/images/imgplaceholder.png"
                                                    class="gambar img-responsive img-thumbnail" id="chekPreview1"
                                                    style="max-width: 200px; " />
                                            </figure>
                                            <input type="file" id="image1" class="item-img1 file center-block"
                                                accept="image/gif, image/jpeg, image/png" name="bannerimg"
                                                onchange="validateMultipleImage('image1')" />
                                            <textarea name="image" id="imageValue1" cols="30" rows="10"
                                                hidden></textarea>
                                        </label>
                                        <div class="modal fade" id="modal1" tabindex="-1" role="dialog"
                                            aria-labelledby="myModalLabel" aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                            aria-label="Close"></button>
                                                        <h4 class="modal-title" id="myModalLabel">
                                                            <?=multiLanguage( "Edit Foto" , "Edit Photo" )?>
                                                        </h4>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div id="upload-demo1"
                                                            style=" height: 250px; padding-bottom:25px;"
                                                            class="center-block">
                                                            <img src="" id="sampleImage1"
                                                                style="width:100px; height:100px" />
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-default"
                                                            data-dismiss="modal">Close</button>
                                                        <button type="button" id="crop1"
                                                            class="btn btn-primary">Crop</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-4">
                                        <label class="form-label">Coupon Title</label>
                                        <input type="text" placeholder="Type here" name="title" class="form-control"
                                            id="title" />
                                    </div>
                                    <div class="mb-4">
                                        <label class="form-label">Code</label>
                                        <input type="text" placeholder="Type here" name="code" class="form-control"
                                            id="code" />
                                        <p id="codep" style="color: red;"></p>
                                    </div>
                                    <div class="mb-4">
                                        <label class="form-label">Coupon Discount</label>
                                        <input type="text" placeholder="Discount in Percentage" name="discount"
                                            class="form-control" id="discount" />
                                        <p id="discountp" style="color: red;"></p>
                                    </div>
                                    <div class="mb-4">
                                        <label class="form-label">Minimum Amount</label>
                                        <input type="text" placeholder="Minimum Amount" name="min_amount"
                                            class="form-control" id="min_amount" />
                                        <p id="min_amountp" style="color: red;"></p>
                                    </div>
                                    <div class="mb-4">
                                        <label class="form-label">Maximum Use</label>
                                        <input type="text" placeholder="MAximum Usage" name="Max_use"
                                            class="form-control" id="max_use" />
                                        <p id="max_usep" style="color: red;"></p>
                                    </div>
                                    <div class="mb-4">
                                        <label class="form-label">Expire Date</label>
                                        <input type="datetime-local" placeholder="Select Date" name="date"
                                            class="form-control" id="date" />
                                        <p id="datep" style="color: red;"></p>
                                    </div>
                                    <div class="mb-4">
                                        <label class="form-label">Coupon Description</label>
                                        <input type="text" placeholder="Type here" name="description"
                                            class="form-control" id="description" />
                                    </div>

                                    <div class="d-grid pb-3">
                                        <button class="btn btn-primary" type="submit">Add Coupon</button>

                                    </div>
                                </form>
                                <hr>
                            </div>
                            <div class="col-md-8">
                                <table id="datatable-buttons"
                                    class="table table-striped table-bordered dt-responsive nowrap"
                                    style="border-collapse: collapse; border-spacing: 0; width: 100%;">
                                    <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>Code</th>
                                            <th>Discount <b>%</b></th>
                                            <th>Min Amount</th>
                                            <th>Max Use</th>
                                            <th>Expire</th>
                                            <th class="text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <%for(i=0;i<coupons.length;i++){%>
                                            <tr id="tr_<%=coupons[i]._id%>">
                                                <td>
                                                    <%=coupons[i].title%>
                                                </td>
                                                <td>
                                                    <%=coupons[i].code%>
                                                </td>
                                                <td>
                                                    <%=coupons[i].discount%>
                                                </td>
                                                <td>
                                                    <%=coupons[i].min_amount%>
                                                </td>
                                                <td>
                                                    <%=coupons[i].Max_use%>
                                                </td>
                                                <td>
                                                    <%=coupons[i].date%>
                                                </td>
                                                <td class="text-end">
                                                    <!-- <a class="btn btn-success"
                                                        onclick="editCoupon('<%=coupons[i]._id%>','<%=coupons[i].title%>','<%=coupons[i].code%>','<%=coupons[i].discount%>','<%=coupons[i].min_amount%>','<%=coupons[i].Max_use%>','<%=coupons[i].date%>')">Edit</a> -->
                                                    <a class="btn btn-danger"
                                                        onclick="deleteCoupon('<%=coupons[i]._id%>')">Delete</a>
                                                </td>
                                            </tr>
                                            <%}%>
                                    </tbody>
                                </table>
                            </div> <!-- .col// -->
                        </div> <!-- .row // -->
                    </div> <!-- card body .// -->
                </div> <!-- card .// -->



            </section> <!-- content-main end// -->
        </div>
        <!-- End Page-content -->
    </div>
    <!-- end main content-->

</div>
<!-- END layout-wrapper -->

</body>


<!-- JAVASCRIPT -->
<script src="/admin/libs/jquery/jquery.min.js"></script>
<script src="/admin/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/admin/libs/metismenu/metisMenu.min.js"></script>
<script src="/admin/libs/simplebar/simplebar.min.js"></script>
<script src="/admin/libs/node-waves/waves.min.js"></script>

<!-- card end// -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

<!-- sweat alert -->
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>

    function validateMultipleImage(id) {
        console.log(id);
        var formData = new FormData();
        var file = document.getElementById(id).files[0];
        formData.append("Filedata", file);
        var t = file.type.split('/').pop().toLowerCase();
        if (t != "jpeg" && t != "jpg" && t != "png" && t != "bmp" && t != "gif") {
            Swal.fire(
                'Not a valid Image file',
                'Select A correct Image file'
            )
            document.getElementById(id).value = '';
            return false;
        }
    }


    $(function () {
        var dtToday = new Date();

        var month = dtToday.getMonth() + 1;
        var day = dtToday.getDate() + 1;
        var year = dtToday.getFullYear();
        var time = dtToday.getHours() + ":" + dtToday.getMinutes();
        if (month < 10)
            month = '0' + month.toString();
        if (day < 10)
            day = '0' + day.toString();

        var maxDate = year + '-' + month + '-' + day + 'T' + time;
        // console.log(maxDate);
        // or instead:
        // var maxDate1 = dtToday.toISOString().substr(0, 10)+"T"+time;
        // console.log(maxDate1);

        $('#date').attr('min', maxDate);
    });

    function editCoupon() {
        console.log("here");
        event.preventDefault()


        let bannerImageError = true;

        function validateBannerImage() {
            console.log('ethyy');
            let bannerimage = $('#imageValue1').val()
            if (bannerimage.length == '') {

                Swal.fire(

                    'Select A Image file'
                )

                bannerImageError = false;
                return false;

            }
        }


        // vlidate title
        let titleErr = true
        function validateTitle() {
            console.log('ethyy');
            $('#edit_title').css('border-color', '#2d3448')
            let title = $('#edit_title').val()
            if (title.length == '') {

                $('#edit_title').css('border-color', '#f30000')
                $('#edit_title').attr("placeholder", "Enter Title")
                titleErr = false;
                return false;
            }
        }

        // validate date
        let dateErr = true
        function validateDate() {
            $('#edit_date').css('border-color', '#2d3448')

            let date = $('#edit_date').val()
            if (date.length == '') {

                $('#edit_date').css('border-color', '#f30000')
                $('#edit_date').html("Select Date")
                dateErr = false;
                return false;
            }
        }

        // validate discount
        let discountErr = true
        function validatediscount() {
            let regnum = new RegExp("^[0-9]+$");
            $('#edit_discount').css('border-color', '#2d3448')
            let discount = $('#edit_discount').val()
            if (discount.length == '') {

                $('#edit_discount').css('border-color', '#f30000')
                $('#edit_discount').attr("placeholder", "Enter Discount")
                discountErr = false;
                return false;
            }
            if (!regnum.test(discount)) {
                $('#edit_discount').css('border-color', '#f30000')
                discountErr = false;
                return false;
            } else if (discount < 1 || discount > 99) {
                console.log("here");
                $('#edit_discount').css('border-color', '#f30000')
                discountErr = false;
                return false;
            }

        }

        // validate min amount
        let minAmountErr = true
        function validateMinAmount() {
            let regnum = new RegExp("^[0-9]+$");
            $('#edit_min_amount').css('border-color', '#2d3448')
            let minAmount = $('#edit_min_amount').val()
            if (minAmount.length == '') {

                $('#edit_min_amount').css('border-color', '#f30000')
                $('#edit_min_amount').attr("placeholder", "Enter Min Amount")
                minAmountErr = false;
                return false;
            }
            if (!regnum.test(minAmount)) {
                $('#edit_min_amount').css('border-color', '#f30000')
                minAmountErr = false;
                return false;
            }

        }

        // validate max use
        let maxUseErr = true
        function validateMaxUse() {
            let regnum = new RegExp("^[0-9]+$");
            $('#edit_max_use').css('border-color', '#2d3448')
            let maxUse = $('#edit_max_use').val()
            if (maxUse.length == '') {

                $('#edit_max_use').css('border-color', '#f30000')
                $('#edit_max_use').attr("placeholder", "Enter Max Use")
                maxUseErr = false;
                return false;
            }
            if (!regnum.test(maxUse)) {
                $('#edit_max_use').css('border-color', '#f30000')
                maxUseErr = false;
                return false;
            }

        }

        // validate code
        let codeErr = true
        function validateCode() {
            $('#edit_code').css('border-color', '#2d3448')
            let code = $('#edit_code').val()
            if (code.length == '') {

                $('#edit_code').css('border-color', '#f30000')
                $('#edit_code').attr("placeholder", "Enter Code")
                codeErr = false;
                return false;
            }
        }

        validateBannerImage()
        validateTitle()
        validateDate()
        validateMinAmount()
        validateMaxUse()
        validatediscount()
        validateCode()

        if (bannerImageError === true && titleErr === true && dateErr === true && discountErr === true && codeErr === true && minAmountErr === true && maxUseErr === true) {

            $.ajax({
                url: '/admin/add-coupon',
                method: 'post',
                data: $('#form').serialize(),
                success: () => {

                    $("#table_change").load(location.href + " #table_change");

                }
            })
        }
    }


    $('document').ready(function () {
        //modal1 and image 1
        var image1 = document.getElementById('sampleImage1');
        var modal1 = $('#modal1');
        var cropper1;

        $('#image1').change(function (event) {
            var files = event.target.files;

            var done = function (url) {
                image1.src = url;
                modal1.modal('show');
            };

            if (files && files.length > 0) {
                reader = new FileReader();
                reader.onload = function (event) {
                    done(reader.result);
                };
                reader.readAsDataURL(files[0]);
            }
        });

        modal1.on('shown.bs.modal', function () {
            cropper1 = new Cropper(image1, {
                aspectRatio: 272 / 295,
                viewMode: 1,
                preview: '#preview1'
            });
        }).on('hidden.bs.modal', function () {
            cropper1.destroy();
            cropper1 = null;
        });

        $('#crop1').click(function () {
            canvas = cropper1.getCroppedCanvas({
                width: 544,
                height: 590
            });

            canvas.toBlob(function (blob) {
                url = URL.createObjectURL(blob);
                var reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = function () {
                    var base64data = reader.result;
                    modal1.modal('hide');
                    $("#imageValue1").val(base64data)
                    $('#chekPreview1').attr('src', base64data);
                };
            });
        });
        //modal1 and image 1 end
    });



    $('#form').submit((e) => {
        e.preventDefault()


        let bannerImageError = true;

        function validateBannerImage() {
            console.log('ethyy');
            let bannerimage = $('#imageValue1').val()
            if (bannerimage.length == '') {

                Swal.fire(

                    'Select A Image file'
                )

                bannerImageError = false;
                return false;

            }
        }


        // vlidate title
        let titleErr = true
        function validateTitle() {
            $('#title').css('border-color', '#2d3448')
            let title = $('#title').val()
            if (title.length == '') {

                $('#title').css('border-color', '#f30000')
                $('#title').attr("placeholder", "Enter Title")
                titleErr = false;
                return false;
            }
        }

        // validate date
        let dateErr = true
        function validateDate() {
            $('#date').css('border-color', '#2d3448')
            $('#datep').html("")

            let date = $('#date').val()
            let thisDate = new Date(date)
            let currDate = new Date()
            if (date.length == '') {

                $('#date').css('border-color', '#f30000')
                $('#datep').html("Select Date")
                dateErr = false;
                return false;
            } else if (thisDate < currDate) {
                $('#date').css('border-color', '#f30000')
                $('#datep').html("Select A Valid Expire Date")
                dateErr = false;
                return false;
            }
        }

        // validate discount
        let discountErr = true
        function validatediscount() {
            let regnum = new RegExp("^[0-9]+$");
            $('#discount').css('border-color', '#2d3448')
            $('#discountp').html("")
            let discount = $('#discount').val()
            if (discount.length == '') {

                $('#discount').css('border-color', '#f30000')
                $('#discount').attr("placeholder", "Enter Discount")
                discountErr = false;
                return false;
            }
            if (!regnum.test(discount)) {
                $('#discount').css('border-color', '#f30000')
                $('#discountp').html("Only numbers allowed")
                discountErr = false;
                return false;
            } else if (discount < 1 || discount > 99) {
                console.log("here");
                $('#discount').css('border-color', '#f30000')
                $('#discountp').html("Enter value between 0 to 100")
                discountErr = false;
                return false;
            }

        }

        // validate min amount
        let minAmountErr = true
        function validateMinAmount() {
            let regnum = new RegExp("^[0-9]+$");
            $('#min_amount').css('border-color', '#2d3448')
            $('#min_amountp').html("")
            let minAmount = $('#min_amount').val()
            if (minAmount.length == '') {

                $('#min_amount').css('border-color', '#f30000')
                $('#min_amount').attr("placeholder", "Enter Min Amount")
                minAmountErr = false;
                return false;
            }
            if (!regnum.test(minAmount)) {
                $('#min_amount').css('border-color', '#f30000')
                $('#min_amountp').html("Only numbers allowed")
                minAmountErr = false;
                return false;
            }

        }

        // validate max use
        let maxUseErr = true
        function validateMaxUse() {
            let regnum = new RegExp("^[0-9]+$");
            $('#max_use').css('border-color', '#2d3448')
            $('#max_usep').html("")
            let maxUse = $('#max_use').val()
            if (maxUse.length == '') {

                $('#max_use').css('border-color', '#f30000')
                $('#max_use').attr("placeholder", "Enter Max Use")
                maxUseErr = false;
                return false;
            }
            if (!regnum.test(maxUse)) {
                $('#max_use').css('border-color', '#f30000')
                $('#max_usep').html("Only numbers allowed")
                maxUseErr = false;
                return false;
            }

        }

        // validate description
        let descriptionErr = true
        function validateDescription() {
            $('#description').css('border-color', '#2d3448')
            let description = $('#description').val()
            if (description.length == '') {

                $('#description').css('border-color', '#f30000')
                $('#description').attr("placeholder", "Enter Description")
                descriptionErr = false;
                return false;
            }
        }

        // validate code
        let codeErr = true
        function validateCode() {
            $('#code').css('border-color', '#2d3448')
            let code = $('#code').val()
            if (code.length == '') {

                $('#code').css('border-color', '#f30000')
                $('#code').attr("placeholder", "Enter Code")
                codeErr = false;
                return false;
            }
        }

        validateBannerImage()
        validateTitle()
        validateDate()
        validateMinAmount()
        validateMaxUse()
        validatediscount()
        validateDescription()
        validateCode()

        if (bannerImageError === true && titleErr === true && dateErr === true && descriptionErr === true && discountErr === true && codeErr === true && minAmountErr === true && maxUseErr === true) {
            console.log("hereeeeeeeee");

            let image = $('#imageValue1').val()
            let title = $('#title').val()
            let date = $('#date').val()
            let discount = $('#discount').val()
            let minAmount = $('#min_amount').val()
            let maxUse = $('#max_use').val()
            let description = $('#description').val()
            let code = $('#code').val()

            let formData = new FormData();
            formData.append('image', image)
            formData.append('title', title)
            formData.append('date', date)
            formData.append('discount', discount)
            formData.append('minAmount', minAmount)
            formData.append('maxUse', maxUse)
            formData.append('description', description)
            formData.append('code', code)

            console.log(formData);
            

            console.log($('#form').serialize());
            $.ajax({
                url: '/admin/add-coupon',
                method: 'post',
                enctype: 'multipart/formdata',
                processData: false,
                contentType: false,
                data: formData,
                success: (response) => {

                    if (response.err === 1) {
                        $('#code').css('border-color', '#f30000')
                        $('#codep').html("Code already Exist!!!")
                    } else {
                        console.log(response);
                        $("#table_change").load(location.href + " #table_change");
                    }

                }
            })
        }


    })

    // delete coupon
    function deleteCoupon(id) {

        Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire(

                    'Deleted!',
                    'Your file has been deleted.',
                    'success',
                    $.ajax({

                        url: '/admin/deleteCoupon',
                        type: 'post',
                        data: { id: id },
                        success: () => {

                            $("#table_change").load(location.href + " #table_change");

                        }
                    })
                )
            }
        })
    }

    // edit coupon 
    function editCoupon(id, title, code, discount, minAmount, maxUse, date) {

        $(`#tr_${id}`).html(
            `
            <form id="edit_form">
            <td>
                <input id="edit_title" type="text" style="width:153px" value="${title}" name="title">
            </td>
            <td>
                <input id='edit_code' type="text" value="${code}" name="code">
            </td>
            <td>
                <input id="edit_discount" type="text" style="width:81px" value="${discount}" name="discount">
            </td>
            <td>
                <input id="edit_min_amount" type="text" style="width:100px" value="${minAmount}" name="min_amount">
            </td>
            <td>
                <input id="edit_Max_use" type="text" style="width:81px" value="${maxUse}" name="Max_use">
            </td>
            <td>
                <input id="edit_expire" type="text" style="width:110px" value="${date}" name="expire">
                <input type="text" style="width:110px; display:none" value="${id}" name="id">
            </td>
            <td class="text-end">
                <a class="btn btn-success" onclick="editCoupon()" >Save</a>
            </td>
            </form>
            `
        )

    }

</script>